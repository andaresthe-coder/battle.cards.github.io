<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CardBattle v.3.2 Medieval Online</title>
<style>
body, html { margin:0; padding:0; font-family:'Times New Roman', serif; background:#000; color:#ffcc00; overflow:hidden; }
#menu,#roomMenu,#game { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10; }
#menu h1,#roomMenu h2 { color:#ffcc00; margin-bottom:2rem; text-align:center; }
button { padding:1rem 2rem; margin:0.5rem; font-size:1.2rem; border:none; border-radius:8px; background:#222; color:#ffcc00; cursor:pointer; transition:0.3s; }
button:hover { background:#555; }
.cards-container { display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; margin:1rem; }
.card { background:#2c2c44; border:2px solid #555577; border-radius:12px; padding:1rem; width:120px; height:160px; display:flex; flex-direction:column; justify-content:space-between; text-align:center; cursor:pointer; transition:0.3s; }
.card:hover { border-color:#ffcc00; transform:translateY(-5px); box-shadow:0 0 10px #ffcc00; }
.hand { border-top:2px solid #555577; margin-top:1rem; padding-top:1rem; min-height:180px; }
.status { display:flex; justify-content:space-around; margin-bottom:1rem; width:90%; }
.status div { background:#333355; padding:1rem; border-radius:12px; min-width:120px; text-align:center; }
.rey-container { position:relative; width:150px; height:20px; background:#555; border-radius:10px; margin:auto; margin-top:5px; }
.rey-bar { height:100%; width:100%; background:#ffcc00; border-radius:10px; transition: width 0.5s; }
</style>
</head>
<body>

<!-- MENÚ PRINCIPAL -->
<div id="menu">
    <h1>CardBattle v.3.2 Medieval</h1>
    <button onclick="startLocalGame()">Juego Local</button>
    <button onclick="showRoomMenu()">Modo Sala Online</button>
    <button onclick="window.location.href='manual.html'">Manual</button>
</div>

<!-- MENÚ SALA -->
<div id="roomMenu" style="display:none;">
    <h2>Modo Sala Online</h2>
    <input type="text" id="roomCode" placeholder="Ingresa código de sala" style="padding:1rem; font-size:1.2rem; border-radius:8px; border:none; margin-bottom:1rem;">
    <button onclick="joinRoom()">Unirse a Sala</button>
    <button onclick="createRoom()">Crear Sala</button>
    <button onclick="backToMenu()">Volver al Menú</button>
</div>

<!-- JUEGO -->
<div id="game" style="display:none; flex-direction:column; align-items:center;">
    <div class="status">
        <div id="player1Status">
            Jugador 1 Rey:
            <div class="rey-container"><div id="player1Life" class="rey-bar"></div></div>
        </div>
        <div id="player2Status">
            Jugador 2 Rey:
            <div class="rey-container"><div id="player2Life" class="rey-bar"></div></div>
        </div>
    </div>
    <h2>Baraja Central</h2>
    <div class="cards-container" id="deckContainer"></div>
    <h2>Mano Jugador Activo</h2>
    <div class="cards-container hand" id="handContainer"></div>
    <div style="text-align:center; margin-top:1rem;">
        <p>Turno de: <span id="currentPlayer">Jugador 1</span></p>
        <button onclick="endTurn()">Terminar Turno</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== CONFIGURACIÓN FIREBASE =====
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_DOMINIO.firebaseapp.com",
  databaseURL: "https://TU_DOMINIO.firebaseio.com",
  projectId: "TU_PROYECTO",
  storageBucket: "TU_DOMINIO.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== VARIABLES GLOBALES =====
let currentPlayer=0;
let playerLife=[1000,1000];
let playerHands=[[],[]];
let currentRoomCode="";
const deck = [
    {name:"Cañón Blitz", type:"Ataque", life:800, attack:700},
    {name:"Capitán Ígneo", type:"Ataque", life:500, attack:400},
    {name:"Arquero", type:"Ataque", life:100, attack:90},
    {name:"Caballero", type:"Ataque", life:200, attack:100},
    {name:"Muralla", type:"Defensa", life:500, attack:0},
    {name:"Escudero", type:"Defensa", life:300, attack:0},
    {name:"Curación", type:"Hechizo", life:0, attack:0},
    {name:"Veneno", type:"Hechizo", life:0, attack:0},
    {name:"Paquete Real", type:"Hechizo", life:0, attack:0},
    {name:"Vacío", type:"Trampa", life:0, attack:0},
    {name:"Espinas", type:"Trampa", life:0, attack:0},
    {name:"Contragolpe", type:"Trampa", life:0, attack:0},
    {name:"Tótem", type:"Especial", life:0, attack:0},
    {name:"Fragmentos Blitz", type:"Especial", life:0, attack:0}
];

// ===== ELEMENTOS HTML =====
const menu = document.getElementById('menu');
const roomMenu = document.getElementById('roomMenu');
const gameDiv = document.getElementById('game');
const deckContainer = document.getElementById('deckContainer');
const handContainer = document.getElementById('handContainer');
const player1LifeBar = document.getElementById('player1Life');
const player2LifeBar = document.getElementById('player2Life');
const currentPlayerSpan = document.getElementById('currentPlayer');

// ===== FUNCIONES MENÚ =====
function startLocalGame(){ menu.style.display='none'; gameDiv.style.display='flex'; renderDeck(); renderHand(); updateLife(); }
function showRoomMenu(){ menu.style.display='none'; roomMenu.style.display='flex'; }
function backToMenu(){ roomMenu.style.display='none'; menu.style.display='flex'; }

// ===== FUNCIONES SALA =====
function createRoom(){
    currentRoomCode = Math.floor(1000 + Math.random()*9000).toString();
    db.ref("rooms/"+currentRoomCode).set({
        players: ["Jugador1"],
        turn:0,
        playerLife:[1000,1000],
        playerHands:[[],[]]
    });
    alert("Sala creada con código: "+currentRoomCode+"\nEsperando 2do jugador...");
    listenRoom();
}

function joinRoom(){
    const code = document.getElementById('roomCode').value;
    db.ref("rooms/"+code).get().then(snapshot=>{
        if(snapshot.exists()){
            currentRoomCode = code;
            db.ref("rooms/"+code+"/players").once('value').then(s=>{
                const players = s.val();
                if(players.length>=2){ alert("Sala llena"); return; }
                players.push("Jugador2");
                db.ref("rooms/"+code+"/players").set(players);
                alert("Te uniste a la sala "+code+"!");
                listenRoom();
            });
        }else{ alert("Sala no encontrada"); }
    });
}

// ===== FUNCIONES JUEGO =====
function listenRoom(){
    roomMenu.style.display='none';
    gameDiv.style.display='flex';
    db.ref("rooms/"+currentRoomCode).on('value',snapshot=>{
        const data = snapshot.val();
        if(data){
            playerLife = data.playerLife;
            playerHands = data.playerHands;
            currentPlayer = data.turn;
            updateLife();
            renderHand();
            currentPlayerSpan.textContent = "Jugador "+(currentPlayer+1);
        }
    });
}

function renderDeck(){
    deckContainer.innerHTML='';
    deck.forEach((card,i)=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML=`<h4>${card.name}</h4><p>${card.type}</p>`;
        div.onclick=()=>takeCard(i);
        deckContainer.appendChild(div);
    });
}

function takeCard(index){
    playerHands[currentPlayer].push(deck[index]);
    saveRoom();
    renderHand();
}

function renderHand(){
    handContainer.innerHTML='';
    playerHands[currentPlayer].forEach((card,i)=>{
        const div = document.createElement('div');
        div.className='card';
        div.innerHTML=`<h4>${card.name}</h4><p>${card.type}</p>`;
        div.onclick=()=>playCard(i);
        handContainer.appendChild(div);
    });
}

function playCard(i){
    const enemy = currentPlayer===0?1:0;
    const card = playerHands[currentPlayer][i];
    if(card.type==="Ataque") playerLife[enemy]-=card.attack;
    if(card.type==="Defensa") playerLife[currentPlayer]+=card.life;
    if(card.type==="Hechizo"){
        if(card.name==="Curación") playerLife[currentPlayer]+=100;
        if(card.name==="Veneno") playerLife[enemy]-=100;
    }
    playerHands[currentPlayer].splice(i,1);
    saveRoom();
    checkVictory();
}

function endTurn(){
    currentPlayer = currentPlayer===0?1:0;
    saveRoom();
}

function updateLife(){
    player1LifeBar.style.width = Math.max(playerLife[0]/10,0)+'%';
    player2LifeBar.style.width = Math.max(playerLife[1]/10,0)+'%';
}

function checkVictory(){
    if(playerLife[0]<=0){ alert("Jugador 2 gana!"); resetGame(); }
    if(playerLife[1]<=0){ alert("Jugador 1 gana!"); resetGame(); }
}

function resetGame(){
    playerLife=[1000,1000];
    playerHands=[[],[]];
    currentPlayer=0;
    updateLife();
    saveRoom();
}

function saveRoom(){
    db.ref("rooms/"+currentRoomCode).set({
        players:["Jugador1","Jugador2"],
        turn: currentPlayer,
        playerLife: playerLife,
        playerHands: playerHands
    });
}
</script>
</body>
</html>
